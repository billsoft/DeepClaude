# DeepClaude 项目实施部署指南

本文档详细说明了 DeepClaude 项目的部署流程，包括环境准备、配置说明和多种部署方案。

## 目录

- [环境要求](#环境要求)
- [本地开发环境配置](#本地开发环境配置)
- [Docker 部署方案](#docker-部署方案)
- [项目验证](#项目验证)
- [常见问题排查](#常见问题排查)
- [性能优化建议](#性能优化建议)

## 环境要求

### 系统要求

- 操作系统：Linux、macOS 或 Windows
- CPU：1核或更高
- 内存：2GB或更高
- 磁盘空间：至少500MB可用空间

### 基础环境

- Python 3.11 或更高版本
- pip 包管理器（通常随Python一起安装）
- Git（用于版本控制和代码获取）
- Docker（可选，用于容器化部署）
- 虚拟环境管理工具（推荐使用pyenv或venv）

### 依赖包

项目主要依赖以下包（详见requirements.txt）：

```
aiohttp>=3.11.11     # 异步HTTP客户端/服务器框架
colorlog>=6.9.0      # 彩色日志输出
fastapi>=0.115.8     # 现代化的Web框架
python-dotenv>=1.0.1 # 环境变量管理
tiktoken>=0.8.0      # Token计数工具
uvicorn[standard]>=0.34.0  # ASGI服务器
```

### 网络要求

- 稳定的互联网连接
- 能够访问以下API服务：
  - Anthropic API (claude-3系列模型)
  - DeepSeek API (deepseek-reasoner模型)
- 建议使用HTTPS进行安全通信

## 本地开发环境配置

### 1. Python 环境配置

1. 安装 Python 环境管理工具（以 pyenv 为例）：

```bash
# macOS
brew install pyenv

# Linux
curl https://pyenv.run | bash
```

2. 配置 pyenv（添加到 ~/.bashrc 或 ~/.zshrc）：
```bash
export PATH="$HOME/.pyenv/bin:$PATH"
eval "$(pyenv init --path)"
eval "$(pyenv init -)"
```

3. 安装并设置 Python 版本：
```bash
# 安装 Python 3.11
pyenv install 3.11.0

# 设置项目的 Python 版本
cd /path/to/project
pyenv local 3.11.0
```

### 2. 虚拟环境配置

1. 创建虚拟环境：
```bash
# 使用 venv
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/macOS
source venv/bin/activate
```

### 3. 项目依赖安装

1. 更新 pip：
```bash
pip install --upgrade pip
```

2. 安装项目依赖：
```bash
pip install -r requirements.txt
```

### 4. 环境变量配置

1. 复制环境变量模板文件：
```bash
cp .env.example .env
```

2. 编辑 .env 文件，配置必要的环境变量：
```env
# API 访问控制
ALLOW_API_KEY=your_allow_api_key  # 设置访问API的密钥
ALLOW_ORIGINS="*"                # 允许的跨域来源

# DeepSeek API 配置
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-reasoner
IS_ORIGIN_REASONING=true

# Claude API 配置
CLAUDE_API_KEY=your_claude_api_key
CLAUDE_MODEL=claude-3-5-sonnet-20241022
CLAUDE_PROVIDER=anthropic
CLAUDE_API_URL=https://api.anthropic.com/v1/messages

# 日志配置
LOG_LEVEL=INFO  # 可选：DEBUG, INFO, WARNING, ERROR
```

### 5. 启动本地服务

1. 基本启动命令：
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

2. 开发模式启动（自动重载）：
```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

## Docker 部署方案

### 方案一：使用 docker-compose（推荐）

1. 确保已安装 Docker 和 Docker Compose

2. 在项目根目录下运行：
```bash
docker-compose up -d
```

### 方案二：手动构建镜像

1. 构建 Docker 镜像：
```bash
docker build -t deepclaude:latest .
```

2. 运行容器：
```bash
docker run -d \
    -p 8000:8000 \
    -e ALLOW_API_KEY=your_allow_api_key \
    -e ALLOW_ORIGINS="*" \
    -e DEEPSEEK_API_KEY=your_deepseek_api_key \
    -e DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions \
    -e DEEPSEEK_MODEL=deepseek-reasoner \
    -e IS_ORIGIN_REASONING=true \
    -e CLAUDE_API_KEY=your_claude_api_key \
    -e CLAUDE_MODEL=claude-3-5-sonnet-20241022 \
    -e CLAUDE_PROVIDER=anthropic \
    -e CLAUDE_API_URL=https://api.anthropic.com/v1/messages \
    -e LOG_LEVEL=INFO \
    --restart always \
    deepclaude:latest
```

## 项目验证

### 1. 服务状态检查

访问以下地址验证服务是否正常运行：
```
http://localhost:8000/docs
```

### 2. API 测试

使用 curl 测试 API 接口：
```bash
curl -X POST "http://localhost:8000/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_allow_api_key" \
  -d '{
    "messages": [{"role": "user", "content": "Hello"}],
    "model": "claude-3-sonnet-20240229"
  }'
```

### 3. 日志检查

检查容器日志：
```bash
# 如果使用 docker-compose
docker-compose logs -f

# 如果直接使用 docker
docker logs -f <container_id>
```

## 常见问题排查

1. 如果遇到权限问题，检查：
   - API Key 是否正确配置
   - ALLOW_ORIGINS 是否正确设置

2. 如果服务无法启动，检查：
   - 端口 8000 是否被占用
   - 环境变量是否正确配置
   - Python 版本是否符合要求

3. 如果 API 调用失败，检查：
   - 网络连接是否正常
   - API Key 是否有效
   - 请求格式是否正确

## 性能优化建议

1. 在生产环境中，建议：
   - 使用 Nginx 作为反向代理
   - 配置适当的并发连接数
   - 启用日志轮转

2. 对于高并发场景：
   - 调整 uvicorn 的工作进程数
   - 配置合适的超时时间
   - 考虑使用负载均衡