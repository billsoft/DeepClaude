# DeepClaude 项目实施部署指南

本文档详细说明了 DeepClaude 项目的部署流程，包括环境准备、配置说明和多种部署方案。

## 目录

- [环境要求](#环境要求)
- [本地开发环境配置](#本地开发环境配置)
- [Docker 部署方案](#docker-部署方案)
- [项目验证](#项目验证)

## 环境要求

### 基础环境

- Python 3.11 或更高版本
- pip 包管理器
- Docker（如需容器化部署）

### 依赖包

项目主要依赖以下包：

```
aiohttp>=3.11.11
colorlog>=6.9.0
fastapi>=0.115.8
python-dotenv>=1.0.1
tiktoken>=0.8.0
uvicorn[standard]>=0.34.0
```

## 本地开发环境配置

### 1. Python 环境配置

对于 M4 Mac 用户，建议使用 pyenv 管理 Python 版本：

```bash
# 安装 pyenv
brew install pyenv

# 安装 Python 3.11
pyenv install 3.11.0

# 设置项目的 Python 版本
cd /path/to/project
pyenv local 3.11.0
```

### 2. 项目依赖安装

```bash
# 安装项目依赖
pip install -r requirements.txt
```

### 3. 环境变量配置

1. 复制环境变量模板文件：
```bash
cp .env.example .env
```

2. 编辑 .env 文件，配置必要的环境变量：
```env
ALLOW_API_KEY=your_allow_api_key
ALLOW_ORIGINS="*"
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-reasoner
IS_ORIGIN_REASONING=true
CLAUDE_API_KEY=your_claude_api_key
CLAUDE_MODEL=claude-3-5-sonnet-20241022
CLAUDE_PROVIDER=anthropic
CLAUDE_API_URL=https://api.anthropic.com/v1/messages
LOG_LEVEL=INFO
```

### 4. 启动本地服务

```bash
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

## Docker 部署方案

### 方案一：使用 docker-compose（推荐）

1. 确保已安装 Docker 和 Docker Compose

2. 在项目根目录下运行：
```bash
docker-compose up -d
```

### 方案二：手动构建镜像

1. 构建 Docker 镜像：
```bash
docker build -t deepclaude:latest .
```

2. 运行容器：
```bash
docker run -d \
    -p 8000:8000 \
    -e ALLOW_API_KEY=your_allow_api_key \
    -e ALLOW_ORIGINS="*" \
    -e DEEPSEEK_API_KEY=your_deepseek_api_key \
    -e DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions \
    -e DEEPSEEK_MODEL=deepseek-reasoner \
    -e IS_ORIGIN_REASONING=true \
    -e CLAUDE_API_KEY=your_claude_api_key \
    -e CLAUDE_MODEL=claude-3-5-sonnet-20241022 \
    -e CLAUDE_PROVIDER=anthropic \
    -e CLAUDE_API_URL=https://api.anthropic.com/v1/messages \
    -e LOG_LEVEL=INFO \
    --restart always \
    deepclaude:latest
```

## 项目验证

### 1. 服务状态检查

访问以下地址验证服务是否正常运行：
```
http://localhost:8000/docs
```

### 2. API 测试

使用 curl 测试 API 接口：
```bash
curl -X POST "http://localhost:8000/v1/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_allow_api_key" \
  -d '{
    "messages": [{"role": "user", "content": "Hello"}],
    "model": "claude-3-sonnet-20240229"
  }'
```

### 3. 日志检查

检查容器日志：
```bash
# 如果使用 docker-compose
docker-compose logs -f

# 如果直接使用 docker
docker logs -f <container_id>
```

## 常见问题排查

1. 如果遇到权限问题，检查：
   - API Key 是否正确配置
   - ALLOW_ORIGINS 是否正确设置

2. 如果服务无法启动，检查：
   - 端口 8000 是否被占用
   - 环境变量是否正确配置
   - Python 版本是否符合要求

3. 如果 API 调用失败，检查：
   - 网络连接是否正常
   - API Key 是否有效
   - 请求格式是否正确

## 性能优化建议

1. 在生产环境中，建议：
   - 使用 Nginx 作为反向代理
   - 配置适当的并发连接数
   - 启用日志轮转

2. 对于高并发场景：
   - 调整 uvicorn 的工作进程数
   - 配置合适的超时时间
   - 考虑使用负载均衡