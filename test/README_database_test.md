# 数据库功能测试说明

## 测试目的

`test_database.py` 文件用于测试 DeepClaude 项目的数据库存储功能，确保所有数据库操作正常工作，包括：

1. 用户管理（创建、查询）
2. 对话会话管理（创建、更新、删除）
3. 对话历史记录（添加、查询）
4. 满意度评价和反馈
5. 用户对话列表查询

## 测试流程

测试流程设计为以下步骤：

1. 获取或创建管理员用户
2. 创建测试用户
3. 创建对话会话
4. 添加用户问题
5. 添加AI回答和思考过程
6. 获取和验证对话历史
7. 更新对话标题
8. 添加满意度评价和反馈
9. 获取用户对话列表
10. 删除对话和历史记录
11. 清理测试用户
12. 验证所有测试数据已正确清理

所有测试都按照序号顺序执行，确保测试的依赖关系正确。每个测试都会验证操作结果，并在数据库中检查数据是否正确存储或删除。

## 运行测试

### 前提条件

1. 确保已安装所有依赖：`pip install -r requirements.txt`
2. 确保数据库连接配置正确（通过环境变量 `DB_URL` 设置）
3. 确保数据库中已创建所需的表结构

### 运行方法

可以通过以下命令运行测试：

```bash
# 在项目根目录下运行
python -m test.test_database

# 或者进入test目录后运行
cd test
python test_database.py
```

也可以使用 unittest 框架指定运行特定测试：

```bash
# 运行特定测试方法
python -m unittest test.test_database.TestDatabaseOperations.test_01_get_or_create_admin_user

# 运行所有测试但显示详细输出
python -m unittest -v test.test_database
```

### 日志输出

测试过程中会输出详细的日志，包括每个测试步骤的操作和结果。日志级别可以通过环境变量 `LOG_LEVEL` 调整。

## 测试数据处理

为了确保测试不影响生产数据，测试会在完成后清理所有测试创建的数据，包括：

1. 删除测试创建的对话及其历史记录
2. 删除测试创建的用户

**注意**: 测试不会删除管理员用户，因为它可能被系统其他部分使用。

## 故障排除

如果测试失败，请检查：

1. 数据库连接是否正常
2. 数据库表结构是否正确
3. 环境变量是否设置正确
4. 日志中是否有详细的错误信息

如果需要保留测试数据进行调试，可以注释掉 `test_10_delete_conversation` 和 `test_11_cleanup_test_user` 方法。 