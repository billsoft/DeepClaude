[2025-03-05 10:00:39] [INFO] [logger.py:90] 日志级别设置为: INFO
[2025-03-05 10:00:39] [INFO] [main.py:17] 服务即将启动 - host: 0.0.0.0, port: 1124, reload: False
[2025-03-05 10:00:40] [INFO] [auth.py:10] 当前工作目录: /Users/wanglei/code/DeepClaude
[2025-03-05 10:00:40] [INFO] [auth.py:11] 尝试加载.env文件...
[2025-03-05 10:00:40] [INFO] [auth.py:17] ALLOW_API_KEY环境变量状态: 已设置
[2025-03-05 10:00:40] [INFO] [auth.py:24] Loaded API key starting with: Deep
[2025-03-05 10:00:40] [INFO] [core.py:18] 初始化DeepClaude服务...
[2025-03-05 10:00:40] [INFO] [claude_client.py:58] 初始化Claude客户端: provider=anthropic, url=https://claude.agentpt.com/v1/messages
[2025-03-05 10:00:40] [INFO] [deepseek.py:35] 初始化DeepSeek推理提供者: provider=deepseek, url=https://api.deepseek.com/v1/chat/completions, mode=auto
[2025-03-05 10:00:40] [INFO] [core.py:48] 数据库存储已禁用
[2025-03-05 10:00:40] [INFO] [core.py:51] DeepClaude服务初始化完成
[2025-03-05 10:00:40] [INFO] [main.py:171] 开始请求
[2025-03-05 10:00:47] [INFO] [auth.py:56] API密钥验证通过
[2025-03-05 10:00:47] [INFO] [main.py:240] 收到原始请求:
[2025-03-05 10:00:47] [INFO] [main.py:241] 请求头: {'host': '192.168.100.182:1124', 'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'accept': 'application/json', 'content-type': 'application/json', 'user-agent': 'OpenAI/Python 1.64.0', 'x-stainless-lang': 'python', 'x-stainless-package-version': '1.64.0', 'x-stainless-os': 'Linux', 'x-stainless-arch': 'arm64', 'x-stainless-runtime': 'CPython', 'x-stainless-runtime-version': '3.12.3', 'authorization': 'Bearer DeepSYSAI', 'x-stainless-async': 'false', 'x-stainless-retry-count': '0', 'x-stainless-read-timeout': '300.0', 'content-length': '1850'}
[2025-03-05 10:00:47] [INFO] [main.py:242] 请求体: {"messages": [{"role": "system", "content": "始终使用中文沟通。\n阅读问题，能够深入理解问题，分析问题的每部分的含义，进行解释，也能整体把握问题的条件和隐藏条件\n然后细致详细解答(1000%权重)，最佳质量，最有责任的回答\n在回答复杂问题、编程问题、技术问题和有实时性要求的问题时要先调用工具中的搜索功能搜索网上的答案，调用搜索工具tavily\n（此要求权重500%)\n如果不知道当前日期可以先调用 tavily查询今天日期\n"}, {"role": "user", "content": "沈阳天气"}], "model": "gpt-4o", "functions": [{"name": "tavily_search", "description": "A tool for search engine built specifically for AI agents (LLMs), delivering real-time, accurate, and factual results at speed.", "parameters": {"properties": {"query": {"description": "The search query.", "type": "string"}}, "required": ["query"], "type": "object"}}, {"name": "tavily_extract", "description": "A tool for extracting raw content from web pages, designed for AI agents (LLMs).", "parameters": {"properties": {"urls": {"description": "A comma-separated list of URLs to extract content from.", "type": "string"}}, "required": ["urls"], "type": "object"}}], "stream": true, "stream_options": {"include_usage": true}, "user": "2cdb8f37-7fdb-42f2-95d9-140769ef24f4"}
[2025-03-05 10:00:47] [INFO] [main.py:253] 检测到 OpenAI 格式的 functions 定义，正在转换为 tools 格式
[2025-03-05 10:00:47] [INFO] [main.py:271] 转换工具: tavily_search => {"name": "tavily_search", "description": "A tool for search engine built specifically for AI agents (LLMs), delivering real-time, accurate, and factual results at speed.", "input_schema": {"type": "object", "properties": {"query": {"description": "The search query.", "type": "string"}}, "required": ["query"]}}
[2025-03-05 10:00:47] [INFO] [main.py:271] 转换工具: tavily_extract => {"name": "tavily_extract", "description": "A tool for extracting raw content from web pages, designed for AI agents (LLMs).", "input_schema": {"type": "object", "properties": {"urls": {"description": "A comma-separated list of URLs to extract content from.", "type": "string"}}, "required": ["urls"]}}
[2025-03-05 10:00:47] [INFO] [main.py:273] 转换完成，共 2 个工具
[2025-03-05 10:00:47] [INFO] [main.py:280] 收到工具调用请求，包含 2 个工具
[2025-03-05 10:00:47] [INFO] [main.py:296] 工具选择策略: auto
[2025-03-05 10:00:47] [INFO] [main.py:304] 使用流式响应处理请求
[2025-03-05 10:00:47] [INFO] [core.py:62] 开始流式处理请求...
[2025-03-05 10:00:47] [INFO] [core.py:70] 直接透传模式(流式): 包含 2 个工具
[2025-03-05 10:00:47] [INFO] [core.py:81] 最终使用 2 个工具调用Claude
[2025-03-05 10:00:47] [INFO] [core.py:96] 开始调用Claude流式接口...
[2025-03-05 10:00:47] [INFO] [claude_client.py:541] 开始向Claude API发送请求: https://claude.agentpt.com/v1/messages (第1次尝试)
[2025-03-05 10:00:47] [INFO] [claude_client.py:311] 添加了 2 个验证通过的工具到请求
[2025-03-05 10:00:47] [INFO] [claude_client.py:546] Claude API请求体: {"model": "claude-3-7-sonnet-20250219", "temperature": 0.7, "max_tokens": 8192, "messages": [{"role": "user", "content": "沈阳天气"}], "stream": true, "system": "始终使用中文沟通。\n阅读问题，能够深入理解问题，分析问题的每部分的含义，进行解释，也能整体把握问题的条件和隐藏条件\n然后细致详细解答(1000%权重)，最佳质量，最有责任的回答\n在回答复杂问题、编程问题、技术问题和有实时性要求的问题时要先调用工具中的搜索功能搜索网上的答案，调用搜索工具tavily\n（此要求权重500%)\n如果不知道当前日期可以先调用 tavily查询今天日期\n", "top_p": 0.9, "tools": [{"name": "tavily_search", "description": "A tool for search engine built specifically for AI agents (LLMs), delivering real-time, accurate, and factual results at speed.", "input_schema": {"type": "object", "properties": {"query": {"description": "The search query.", "type": "string"}}, "required": ["query"]}}, {"name": "tavily_extract", "description": "A tool for extracting raw content from web pages, designed for AI agents (LLMs).", "input_schema": {"type": "object", "properties": {"urls": {"description": "A comma-separated list of URLs to extract content from.", "type": "string"}}, "required": ["urls"]}}], "tool_choice": {"type": "auto"}}
[2025-03-05 10:00:50] [INFO] [claude_client.py:571] 成功连接到Claude API，开始处理SSE事件流
[2025-03-05 10:00:50] [INFO] [claude_client.py:365] 开始处理Claude SSE事件流
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[1]: 'message_start'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[1] 'message_start' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [WARNING] [claude_client.py:494] 未知事件类型[1]: message_start, 数据: {'type': 'message_start', 'message': {'id': 'msg_01F8gKHdf4L6JHwnexgCMo4c', 'type': 'message', 'role...
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[2]: 'content_block_start'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[2] 'content_block_start' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:421] 内容块开始[2], 类型: text
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[3]: 'ping'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[3] 'ping' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[4]: 'content_block_delta'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[4] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:432] 接收到内容块增量[4], 类型: text_delta
[2025-03-05 10:00:50] [INFO] [claude_client.py:437] 处理文本增量[1]: '您好，我需要为您查询沈阳'
[2025-03-05 10:00:50] [INFO] [core.py:184] 发送文本响应[1]: {"id": "chatcmpl-d1b7ef35-e805-8582-3e22-9b1d62c0-628", "object": "chat.completion.chunk", "created": 1741140050, "model": "gpt-4o", "choices": [{"index": 0, "delta": {"content": "\u60a8\u597d\uff0c\u...
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[5]: 'content_block_delta'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[5] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:432] 接收到内容块增量[5], 类型: text_delta
[2025-03-05 10:00:50] [INFO] [claude_client.py:437] 处理文本增量[2]: '的天气情况。让我使用'
[2025-03-05 10:00:50] [INFO] [core.py:184] 发送文本响应[2]: {"id": "chatcmpl-05a3580b-6a70-1346-5d98-0949f724-e32", "object": "chat.completion.chunk", "created": 1741140050, "model": "gpt-4o", "choices": [{"index": 0, "delta": {"content": "\u7684\u5929\u6c14\u...
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[6]: 'content_block_delta'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[6] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:432] 接收到内容块增量[6], 类型: text_delta
[2025-03-05 10:00:50] [INFO] [claude_client.py:437] 处理文本增量[3]: '搜索工具来获取最新的'
[2025-03-05 10:00:50] [INFO] [core.py:184] 发送文本响应[3]: {"id": "chatcmpl-7e2dc8be-a2c9-de30-a9a4-46a035e9-24f", "object": "chat.completion.chunk", "created": 1741140050, "model": "gpt-4o", "choices": [{"index": 0, "delta": {"content": "\u641c\u7d22\u5de5\u...
[2025-03-05 10:00:50] [INFO] [claude_client.py:398] 接收到新事件[7]: 'content_block_delta'
[2025-03-05 10:00:50] [INFO] [claude_client.py:408] 事件[7] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:50] [INFO] [claude_client.py:432] 接收到内容块增量[7], 类型: text_delta
[2025-03-05 10:00:50] [INFO] [claude_client.py:437] 处理文本增量[4]: '沈阳天气信息。'
[2025-03-05 10:00:50] [INFO] [core.py:184] 发送文本响应[4]: {"id": "chatcmpl-3ba15e1b-11d0-2986-de76-a56a3fab-8bc", "object": "chat.completion.chunk", "created": 1741140050, "model": "gpt-4o", "choices": [{"index": 0, "delta": {"content": "\u6c88\u9633\u5929\u...
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[8]: 'content_block_stop'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[8] 'content_block_stop' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:428] 内容块结束[8], 索引: 0
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[9]: 'content_block_start'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[9] 'content_block_start' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:421] 内容块开始[9], 类型: tool_use
[2025-03-05 10:00:51] [INFO] [claude_client.py:424] 检测到工具使用块开始
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[10]: 'content_block_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[10] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:432] 接收到内容块增量[10], 类型: input_json_delta
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[11]: 'content_block_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[11] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:432] 接收到内容块增量[11], 类型: input_json_delta
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[12]: 'content_block_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[12] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:432] 接收到内容块增量[12], 类型: input_json_delta
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[13]: 'content_block_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[13] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:432] 接收到内容块增量[13], 类型: input_json_delta
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[14]: 'content_block_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[14] 'content_block_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:432] 接收到内容块增量[14], 类型: input_json_delta
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[15]: 'content_block_stop'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[15] 'content_block_stop' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:428] 内容块结束[15], 索引: 1
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[16]: 'message_delta'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[16] 'message_delta' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:456] 接收到消息增量[16], stop_reason: None
[2025-03-05 10:00:51] [INFO] [claude_client.py:398] 接收到新事件[17]: 'message_stop'
[2025-03-05 10:00:51] [INFO] [claude_client.py:408] 事件[17] 'message_stop' 解析数据成功，类型: dict
[2025-03-05 10:00:51] [INFO] [claude_client.py:484] 处理消息生成完成事件
[2025-03-05 10:00:51] [INFO] [claude_client.py:485] 最终文本内容长度: 39 字符
[2025-03-05 10:00:51] [INFO] [claude_client.py:486] 工具调用总数: 0
[2025-03-05 10:00:51] [INFO] [claude_client.py:496] SSE事件流处理完成: 共处理 17 个事件
[2025-03-05 10:00:51] [INFO] [claude_client.py:497] 处理结果: 生成了 4 段文本内容 (39 字符) 和 0 个工具调用
[2025-03-05 10:00:51] [INFO] [claude_client.py:500] 最终工具调用数量: 0
[2025-03-05 10:00:51] [INFO] [claude_client.py:583] 流式请求正常完成
[2025-03-05 10:00:51] [INFO] [core.py:187] 流式处理完成，总共发送了 4 个响应片段 (内容: 4, 工具调用: 0)
[2025-03-05 10:00:51] [INFO] [core.py:414] 发送完成标记(无工具调用)
